{% extends "base.html" %}
{% block title %}KidTube ¬∑ Admin{% endblock %}
{% block content %}
<section class="page-head">
  <div>
    <h1>Admin Control Panel</h1>
    <p class="small">Manage categories, kid profiles, limits, schedules, logs, and sync operations.</p>
  </div>
  <a class="btn-secondary" href="/">Back to Kid Dashboard</a>
</section>
<section class="admin-grid">
  <a class="panel admin-tile" href="/admin/channels"><h2>Channels</h2><p class="small">Search and preview channels before allowing or blocking.</p></a>
  <a class="panel admin-tile" href="/admin/kids"><h2>Kids</h2><p class="small">Create and tune profiles and daily watch limits.</p></a>
  <a class="panel admin-tile" href="/admin/approvals"><h2>Approvals</h2><p class="small">Review pending kid requests and approve or deny.</p></a>
  <a class="panel admin-tile" href="/admin/stats"><h2>Logs + Stats</h2><p class="small">Review search/watch logs and daily totals in one place.</p></a>
  <a class="panel admin-tile" href="/admin/sync"><h2>Sync</h2><p class="small">Run sync and review exactly what changed.</p></a>
  <a class="panel admin-tile" href="#notifications-section"><h2>‚öôÔ∏è Settings</h2><p class="small">Configure Discord, email notifications, and admin PIN.</p></a>
  <a class="panel admin-tile" href="#security-section"><h2>üîí Security</h2><p class="small">Set admin PIN to protect the admin panel.</p></a>
</section>

<section id="notifications-section" class="panel" style="margin-top:1rem;padding:1rem;">
  <h2>Notifications</h2>
  <div style="display:grid;gap:0.6rem;max-width:560px;">
    <input id="approval-email-to" type="email" placeholder="your@email.com (receives approval alerts)" />
    <input id="smtp-username" type="email" placeholder="yourname@gmail.com" />
    <div style="display:flex;gap:0.5rem;align-items:center;">
      <input id="smtp-password" type="password" placeholder="Gmail app password" style="flex:1;" />
      <button id="toggle-smtp-password" type="button" class="btn-secondary">Show</button>
    </div>
    <input id="discord-webhook-url" type="url" placeholder="https://discord.com/api/webhooks/..." />
    <button id="save-notification-settings" class="btn-primary" type="button">Save Settings</button>
    <p class="small" style="margin-top:0.5rem;color:var(--text-muted);">
      For Gmail: use an App Password (not your real password).
      Get one at myaccount.google.com/apppasswords
    </p>
  </div>
</section>

<section id="security-section" class="panel" style="margin-top:1rem;padding:1rem;">
  <h2>Security</h2>
  <p id="admin-pin-status" class="small">Loading PIN status‚Ä¶</p>
  <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
    <input id="new-admin-pin" type="password" inputmode="numeric" pattern="[0-9]{4,6}" maxlength="6" placeholder="New PIN (4-6 digits)" />
    <input id="current-admin-pin" type="password" inputmode="numeric" pattern="[0-9]{4,6}" maxlength="6" placeholder="Current PIN (if required)" />
    <button id="save-admin-pin" class="btn-primary" type="button">Save PIN</button>
    <button id="remove-admin-pin" class="btn-secondary" type="button">Remove PIN</button>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script>
  async function refreshAdminPinStatus() {
    const res = await fetch('/api/session/admin-pin');
    const data = await res.json();
    document.getElementById('admin-pin-status').textContent = data.is_set ? 'PIN is set' : 'No PIN set (anyone can access admin)';
  }

  async function loadNotificationSettings() {
    const res = await fetch('/api/admin/notification-settings');
    if (!res.ok) return;
    const data = await res.json();
    document.getElementById('approval-email-to').value = data.approval_email_to || '';
    document.getElementById('smtp-username').value = data.smtp_username || '';
    document.getElementById('smtp-password').value = '';
    document.getElementById('discord-webhook-url').value = data.discord_approval_webhook_url || '';
  }

  document.getElementById('toggle-smtp-password')?.addEventListener('click', () => {
    const input = document.getElementById('smtp-password');
    input.type = input.type === 'password' ? 'text' : 'password';
    document.getElementById('toggle-smtp-password').textContent = input.type === 'password' ? 'Show' : 'Hide';
  });

  document.getElementById('save-notification-settings')?.addEventListener('click', async () => {
    const payload = {
      approval_email_to: document.getElementById('approval-email-to').value.trim(),
      smtp_username: document.getElementById('smtp-username').value.trim(),
      smtp_password: document.getElementById('smtp-password').value.trim(),
      discord_approval_webhook_url: document.getElementById('discord-webhook-url').value.trim(),
    };
    const res = await fetch('/api/admin/notification-settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const err = await res.json();
      alert(err.detail || 'Unable to save settings');
      return;
    }
    alert('Notification settings saved');
    document.getElementById('smtp-password').value = '';
  });

  document.getElementById('save-admin-pin')?.addEventListener('click', async () => {
    const newPin = document.getElementById('new-admin-pin').value.trim();
    const currentPin = document.getElementById('current-admin-pin').value.trim();
    const res = await fetch('/api/session/admin-pin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ new_pin: newPin, current_pin: currentPin }),
    });
    if (!res.ok) {
      const err = await res.json();
      alert(err.detail || 'Unable to save PIN');
      return;
    }
    document.getElementById('new-admin-pin').value = '';
    document.getElementById('current-admin-pin').value = '';
    await refreshAdminPinStatus();
  });

  document.getElementById('remove-admin-pin')?.addEventListener('click', async () => {
    const res = await fetch('/api/session/admin-pin', { method: 'DELETE' });
    if (!res.ok) {
      const err = await res.json();
      alert(err.detail || 'Unable to remove PIN');
      return;
    }
    await refreshAdminPinStatus();
  });

  refreshAdminPinStatus();
  loadNotificationSettings();
</script>
{% endblock %}
